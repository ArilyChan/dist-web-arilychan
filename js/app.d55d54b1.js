(function(e){function t(t){for(var s,o,a=t[0],c=t[1],u=t[2],d=0,f=[];d<a.length;d++)o=a[d],Object.prototype.hasOwnProperty.call(r,o)&&r[o]&&f.push(r[o][0]),r[o]=0;for(s in c)Object.prototype.hasOwnProperty.call(c,s)&&(e[s]=c[s]);l&&l(t);while(f.length)f.shift()();return i.push.apply(i,u||[]),n()}function n(){for(var e,t=0;t<i.length;t++){for(var n=i[t],s=!0,a=1;a<n.length;a++){var c=n[a];0!==r[c]&&(s=!1)}s&&(i.splice(t--,1),e=o(o.s=n[0]))}return e}var s={},r={app:0},i=[];function o(t){if(s[t])return s[t].exports;var n=s[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=s,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(n,s,function(t){return e[t]}.bind(null,s));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var a=window["webpackJsonp"]=window["webpackJsonp"]||[],c=a.push.bind(a);a.push=t,a=a.slice();for(var u=0;u<a.length;u++)t(a[u]);var l=c;i.push([0,"chunk-vendors"]),n()})({0:function(e,t,n){e.exports=n("56d7")},"0b38":function(e,t,n){"use strict";n("50de")},1:function(e,t){},1165:function(e,t,n){},"50de":function(e,t,n){},5428:function(e,t,n){},"56d7":function(e,t,n){"use strict";n.r(t),n.d(t,"io",(function(){return z}));n("e260"),n("e6cf"),n("cca6"),n("a79d"),n("db4d");var s=n("a026"),r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"chat"}},[n("div",{staticClass:"sidebar"},[n("card"),n("list")],1),n("div",{staticClass:"main"},[n("message"),n("text-input")],1)])},i=[],o=n("5530"),a=n("2f62"),c=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"card"},[n("header",{staticStyle:{display:"flex","align-items":"self-end"}},[n("img",{staticClass:"avatar",attrs:{width:"40",height:"40",alt:e.user.name,src:e.user.img}}),n("div",[n("input",{directives:[{name:"model",rawName:"v-model",value:e.name,expression:"name"}],staticClass:"search",attrs:{placeholder:"your name"},domProps:{value:e.name},on:{input:function(t){t.target.composing||(e.name=t.target.value)}}})])]),n("footer",[n("p",[e._v("在下面填你的token")]),n("input",{directives:[{name:"model",rawName:"v-model",value:e.token,expression:"token"}],staticClass:"search",attrs:{placeholder:"token"},domProps:{value:e.token},on:{input:function(t){t.target.composing||(e.token=t.target.value)}}}),n("p",[e._v("发送 !bindqq 可以生成一个")]),n("p",[e._v("发送token给小阿日绑定qq")]),n("p",[e._v("不需要绑定qq可以不填")]),n("hr"),n("input",{staticClass:"search",attrs:{type:"text",placeholder:"search user..."},on:{keyup:e.onKeyup}})])])},u=[],l=(n("b0c0"),n("ac1f"),n("841c"),{computed:Object(o["a"])(Object(o["a"])({},Object(a["c"])(["user"])),{},{name:{get:function(){return this.user.name},set:function(e){""===e&&(e=null),this.changeUserData({name:e})}},token:{get:function(){return this.user.token},set:function(e){""===e&&(e=null),this.changeUserData({token:e})}}}),methods:Object(o["a"])(Object(o["a"])({},Object(a["b"])(["search","changeUserData"])),{},{onKeyup:function(e){this.search(e.target.value)}})}),d=l,f=(n("b73b"),n("2877")),m=Object(f["a"])(d,c,u,!1,null,"473fff11",null),p=m.exports,g=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"list"},[n("ul",[e._l(e.sessions,(function(t,s){return n("li",{key:s,class:{active:t.id===e.currentId},on:{click:function(n){return e.selectSession(t.id)}}},[n("img",{staticClass:"avatar",attrs:{width:"30",height:"30",alt:t.user.name,src:t.user.img}}),n("p",{staticClass:"name"},[e._v(e._s(t.user.name))])])})),n("li",{on:{click:function(t){return t.stopPropagation(),e.joinRoom()}}},[n("input",{directives:[{name:"model",rawName:"v-model",value:e.joinRoomId,expression:"joinRoomId"}],domProps:{value:e.joinRoomId},on:{input:function(t){t.target.composing||(e.joinRoomId=t.target.value)}}}),n("p",{staticClass:"name"},[e._v("create new room")])])],2)])},v=[],h={computed:Object(o["a"])({},Object(a["c"])(["sessions","currentId"])),methods:Object(o["a"])(Object(o["a"])({},Object(a["b"])(["selectSession","createSession"])),{},{joinRoom:function(){this.$socket.emit("join-room",{room:this.joinRoomId}),this.joinRoomId=""}}),data:function(){return{joinRoomId:void 0}}},S=h,b=(n("e2e5"),Object(f["a"])(S,g,v,!1,null,"12f3ea76",null)),_=b.exports,E=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"text"},[n("textarea",{directives:[{name:"model",rawName:"v-model",value:e.content,expression:"content"}],attrs:{placeholder:"按 Ctrl + Enter 发送"},domProps:{value:e.content},on:{keyup:e.onKeyup,input:function(t){t.target.composing||(e.content=t.target.value)}}}),n("a",{attrs:{href:"#"},on:{click:function(t){return t.stopPropagation(),function(){e.content.length&&e.sendMessage(e.content),e.content=""}()}}},[e._v("Send")])])},O=[],j={data:function(){return{content:""}},methods:Object(o["a"])(Object(o["a"])({},Object(a["b"])(["sendMessage"])),{},{onKeyup:function(e){e.ctrlKey&&13===e.keyCode&&this.content.length&&(this.sendMessage(this.content),this.content="")}})},y=j,w=(n("0b38"),Object(f["a"])(y,E,O,!1,null,"4cdd57c2",null)),C=w.exports,x=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{directives:[{name:"scroll-bottom",rawName:"v-scroll-bottom",value:e.session.messages,expression:"session.messages"}],staticClass:"message"},[e.session?n("ul",e._l(e.session.messages,(function(t,s){return n("li",{key:s},[0===s||new Date(t.date).getMinutes()>new Date(e.session.messages[s-1].date).getMinutes()?n("p",{staticClass:"time"},[n("span",[e._v(e._s(e._f("time")(t.date)))])]):e._e(),n("div",{staticClass:"main",class:{self:t.self}},[n("img",{staticClass:"avatar",attrs:{width:"30",height:"30",src:t.self?e.user.img:e.session.user.img}}),n("div",{staticStyle:{display:"flex","flex-direction":"column","flex-grow":"0"}},[t.self?e._e():n("span",[n("small",[e._v(e._s(t.user.name||t.user.id))])]),n("div",{staticClass:"text",staticStyle:{width:"fit-content"}},e._l(t.content.split("\n"),(function(t,s){return n("div",{key:s},[t.startsWith("[CQ:image")?n("img",{staticClass:"chat-image",attrs:{src:e.CQImageToSrc(t)}}):e.textCQCode(t)?n("p",[e._v(e._s(e.CQCodeToText(t)))]):n("p",[e._v(e._s(t))])])})),0)])])])})),0):e._e()])},T=[],I=(n("c975"),n("fb6a"),n("1276"),n("2ca0"),{computed:Object(o["a"])({},Object(a["c"])(["user","session"])),filters:{time:function(e){"string"===typeof e&&(e=new Date(e));var t=e.getHours()+":"+e.getMinutes().toLocaleString("en-US",{minimumIntegerDigits:2,useGrouping:!1}),n=new Date;return e.toDateString()===n.toDateString()?t:e.toDateString()+" "+t}},methods:{CQImageToSrc:function(e){var t=e.split("file=")[1];if(t=t.split(",")[0],t=t.split("]")[0],!t.startsWith("base64://"))return t;t=t.slice(9);var n,s=window.atob(t),r=s.toLowerCase();return n=-1!==r.indexOf("png")?"png":-1!==r.indexOf("jpg")||-1!==r.indexOf("jpeg")?"jpg":"tiff","data:image/"+n+";base64,"+t},textCQCode:function(e){return e.startsWith("[CQ:")},htmlCQCode:function(e){return!1},CQCodeToText:function(e){var t=e.slice(4).split(",")[0];switch(t){case"at":return"@".concat(e.split("qq=")[1].split(",")[0].slice(0,-1));default:break}}}}),k=I,R=(n("dac1"),Object(f["a"])(k,x,T,!1,null,"6638fa34",null)),A=R.exports,D={components:{Card:p,List:_,TextInput:C,Message:A},methods:Object(o["a"])({},Object(a["b"])(["initData"])),created:function(){this.initData()}},N=D,M=(n("a587"),Object(f["a"])(N,r,i,!1,null,"73d9f3a7",null)),K=M.exports,P=(n("4de4"),n("7db0"),n("c740"),n("4160"),n("caad"),n("d81d"),n("d3b7"),n("25f0"),n("2532"),n("159b"),n("2909")),G=(n("96cf"),n("1da1")),U=n("e013"),L=new U.Db("chat",{messages:["room","message.user.id","message.date","message.self"]}),Q=L.collection("messages"),q=function(){var e=Object(G["a"])(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n||(n=new Date,n.setDate(n.getDate()-3)),e.next=3,Q.find({room:t}).filter({"message.date":{$gte:n}}).toArray();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}();s["a"].use(a["a"]);var H=new a["a"].Store({state:{networkStatus:"unknown",user:{name:"coffce",img:"images/1.jpg"},sessions:[{id:"1",type:"group",user:{name:"default-chat",img:"images/1.jpg",token:""},messages:[]}],currentSessionId:void 0,filterKey:""},getters:{session:function(e){var t=e.sessions,n=e.currentSessionId;return t.find((function(e){return e.id===n}))},user:function(e){var t=e.user;return t},filterKey:function(e){var t=e.filterKey;return t},sessions:function(e){var t=e.sessions,n=e.filterKey,s=t.filter((function(e){return e.user.name.includes(n)}));return s},currentId:function(e){var t=e.currentSessionId;return t}},mutations:{INIT_DATA:function(e){},LAST_1000_MESSAGE:function(e,t){var n=e.sessions,s=e.currentSessionId,r=n.find((function(e){return t===s}));r.messages.length<1e3||r.messages.slice(-1e3,r.messages.length)},SEND_MESSAGE:function(e,t){var n=e.sessions,s=e.currentSessionId,r=n.find((function(e){return e.id===s}));if(!r)throw new Error("no session");var i={content:t,date:new Date,self:!0};r.messages.push(i),Q.insert({room:s,message:i})},RECV_MESSAGE:function(e,t){var n=e.sessions,s=n.find((function(e){return e.id===t.id}));if(!s)throw new Error("no session");var r={content:t.message,date:new Date,user:t.user,self:!1};s.messages.push(r),Q.insert({room:t.id,message:r})},SELECT_SESSION:function(e,t){e.currentSessionId=t},CREATE_SESSION:function(e,t){e.sessions.find((function(e){return e.id===t.id}))||e.sessions.push({id:t.id,type:t.type,user:{id:t.id,name:t.name||t.id.toString(),img:t.avatar||"images/1.jpg"},messages:[]})},RESTORE_SESSION:function(e,t){var n,s=e.sessions.findIndex((function(e){return e.id===t.id}));if(-1===s)return e.sessions.push(t);e.sessions[s].messages||(e.sessions[s].messages=[]),(n=e.sessions[s].messages).push.apply(n,Object(P["a"])(t.messages))},SET_FILTER_KEY:function(e,t){e.filterKey=t},CHANGE_USERDATA:function(e,t){e.user=Object(o["a"])(Object(o["a"])({},e.user),t)},NETWORKSTATUS_CHANGE:function(e,t){e.networkStatus=t}},actions:{rejoinRooms:function(e){e.commit;var t=e.state;e.dispatch;"disconnected"===t.networkStatus&&t.sessions.map((function(e){return z.emit("join-room",{room:e.id})}))},initData:function(e){var t=e.commit,n=e.state,s=e.dispatch;try{var r=JSON.parse(localStorage.getItem("vue-chat-session"));r&&r.length&&r.forEach(function(){var e=Object(G["a"])(regeneratorRuntime.mark((function e(n){var s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,q(n.id);case 2:s=e.sent,n.messages=s.map((function(e){return e.message})),t("RESTORE_SESSION",n);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.sessions.map((function(e){return z.emit("join-room",{room:e.id})}))}catch(c){}var i=Object(o["a"])({},n.user);try{var a=JSON.parse(localStorage.getItem("user"));i=Object(o["a"])(Object(o["a"])({},i),a),i.id||(i.id=Math.floor(2147483647*Math.random())),localStorage.setItem("user",JSON.stringify(i)),s("changeUserData",i)}catch(u){}},changeUserData:function(e,t){var n=e.commit,s=e.state;n("CHANGE_USERDATA",t),localStorage.setItem("user",JSON.stringify(s.user))},sendMessage:function(e,t){var n=e.commit,s=e.state,r=s.sessions.find((function(e){return e.id===s.currentSessionId}));z.emit("client-message",{room:r.id,message:t,user:s.user}),n("SEND_MESSAGE",t),n("LAST_1000_MESSAGE",r.id)},selectSession:function(e,t){var n=e.commit;return n("SELECT_SESSION",t)},search:function(e,t){var n=e.commit;return n("SET_FILTER_KEY",t)},reciveMessage:function(e,t){var n=e.commit;n("RECV_MESSAGE",t),n("LAST_1000_MESSAGE",t.id)},createSession:function(e,t){var n=e.commit;return n("CREATE_SESSION",t)},"SOCKET_joined-room":function(e,t){var n=e.dispatch,s=e.state,r=t.room,i=t.type;n("createSession",{id:r,type:i}),s.currentSessionId||n("selectSession",r)},"SOCKET_client-message":function(e,t){var n=e.dispatch,s=t.room,r=t.user,i=void 0===r?{}:r,o=t.message;n("reciveMessage",{id:s,user:i,message:o})}}});H.watch((function(e){return e.sessions}),(function(e){localStorage.setItem("vue-chat-session",JSON.stringify(e.map((function(e){var t=e.id,n=e.type,s=e.user;return{id:t,type:n,user:s}}))))}),{deep:!0});var $=H,J=n("5132"),W=n.n(J),F=n("8055"),V=n.n(F);s["a"].config.devtools=!0,s["a"].directive("scroll-bottom",(function(e,t,n){n.context.$nextTick((function(){e.scrollTop=e.scrollHeight-e.clientHeight}))}));var Y={},z=V()("http://34.84.137.137:3004/chat",Y);s["a"].use(new W.a({debug:!0,connection:z,vuex:{store:$,actionPrefix:"SOCKET_",mutationPrefix:"SOCKET_"}})),new s["a"]({el:"#app",components:{App:K},template:"<App/>",store:$,sockets:{connect:function(){"disconnected"===$.state.networkStatus&&$.dispatch("rejoinRooms"),$.commit("NETWORKSTATUS_CHANGE","connected")},disconnect:function(){console.log("socket disconnected"),$.commit("NETWORKSTATUS_CHANGE","disconnected")}}})},a587:function(e,t,n){"use strict";n("d723")},acfd:function(e,t,n){},b73b:function(e,t,n){"use strict";n("1165")},d723:function(e,t,n){},dac1:function(e,t,n){"use strict";n("5428")},e2e5:function(e,t,n){"use strict";n("acfd")}});
//# sourceMappingURL=app.d55d54b1.js.map